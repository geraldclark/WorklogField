({fieldTag:"textarea",maxDisplayLength:450,isTruncated:false,lastMode:null,plugins:["EllipsisInline"],events:{"click .show-more-text":"toggleMoreText"},initialize:function(e){this.userTimePrefs=app.user.getPreference("timepref");this.userDatePrefs=app.user.getPreference("datepref");this.userTzPrefs=app.user.getPreference("tz_offset");if(_.isUndefined(this.model.worklogUsers)){this.model.worklogUsers=null}app.view.Field.prototype.initialize.call(this,e)},format:function(e){var t=e;var n=this.value;if(typeof n=="string"){n=n.replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"<br>")}if(typeof t=="string"){t=t.replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"<br>")}var r;timestampReg=new RegExp(/<timestamp[^>]*>(.*?)<\/timestamp>/gm);while(!_.isNull(r=timestampReg.exec(e))){jsDate=new Date(parseInt(r[1].trim())*1e3);jsdate=app.date.UTCtoTimezone(jsDate,this.userTzPrefs);matchText=r[0].trim();displayTime=app.date.format(jsDate,this.userDatePrefs)+" at "+app.date.format(jsDate,this.userTimePrefs);if(typeof n=="string"){n=n.replace(matchText,"<strong>on "+displayTime+"</strong>")}if(typeof t=="string"){t=t.replace(matchText,"<strong>"+displayTime+"</strong>")}}for(var i in this.model.worklogUsers){displayName=this.model.worklogUsers[i];userURL='<a href="#bwc/index.php?module=Employees&action=DetailView&record='+i+'" data-original-title="'+displayName+'">'+displayName+"</a>";replacement="<strong>"+userURL+"</strong> ";search="<user>"+i+"</user>";if(typeof n=="string"){n=n.split(search).join(replacement)}if(typeof t=="string"){t=t.split(search).join(replacement)}}this.value=n;e=t;return this.value||e||""},unformat:function(e){if(this.storedValue!=""){this.storedValue=this.storedValue+"\n\n"}utcStamp=(new Date).valueOf()/1e3;return this.storedValue+"<user>"+App.user.attributes.id+"</user><timestamp>"+utcStamp+"</timestamp>\n"+e},_render:function(){var e=this.model.get(this.name);if(_.isNull(this.model.worklogUsers)&&!_.isNull(this.model)&&this.context.isDataFetched()){userIds=new Array;userReg=new RegExp(/<user[^>]*>(.*?)<\/user>/gm);while(!_.isNull(userResult=userReg.exec(e))){userId=userResult[1].trim();if(userIds.indexOf(userId)==-1){if(userId!=App.user.attributes.id){userIds[userIds.length]=userId}}}if(userIds.length==0){this.model.worklogUsers=new Object;this.model.worklogUsers[App.user.attributes.id]=App.user.attributes.full_name;app.view.Field.prototype._render.call(this);return}data=new Object;data.ids=userIds;var t=this;App.api.call("create",App.api.buildURL("worklog/users"),data,{success:function(e){t.model.worklogUsers=e;t.model.worklogUsers[App.user.attributes.id]=App.user.attributes.full_name;t._renderField()},error:function(e){app.error.handleHttpError(e);if(callback)callback(e)}});this.value='<i class="icon-spinner icon-spin"></i>';app.view.Field.prototype._render.call(this);return}this._renderField()},_renderField:function(){this.def.css_class=this.def.css_class||"textarea-text";var e=this.model.get(this.name);this.storedValue=e;if(!_.isUndefined(e)&&e.length>this.maxDisplayLength){this.isTooLong=true}else{this.isTooLong=false;this.lastMode=null;this.value=e}if(this.lastMode&&this.tplName==="edit"){if(this.lastMode==="more"){this.showMore();return}this.showLess();return}app.view.Field.prototype._render.call(this);this.$el.addClass(this.def.css_class);if(this._notListView()){if(this.tplName!=="edit"){if(this.isTooLong){this.showLess()}if(this.tplName==="disabled"){this.$(this.fieldTag).attr("disabled","disabled")}}else{this.value=e;app.view.Field.prototype._render.call(this)}}},_notListView:function(){if(this.view.name!=="list"||this.view.meta&&this.view.meta.type!=="list"){return true}return false},toggleMoreText:function(){if(this.isTruncated){this.showMore()}else{this.showLess()}},showMore:function(){this._toggleTextLength("more")},showLess:function(){this._toggleTextLength("less")},_toggleTextLength:function(e){var t,n,r;r=this.model.get(this.name);if(e==="more"){t=r.trim()+"...";this.isTruncated=false;n=app.lang.get("LBL_LESS",this.module).toLocaleLowerCase()}else{t=r.substring(0,this.maxDisplayLength).trim()+"...";this.isTruncated=true;n=app.lang.get("LBL_MORE",this.module).toLocaleLowerCase()}this.value=t;this.$el.empty();app.view.Field.prototype._render.call(this);this.$(".show-more-text").text(n);this.lastMode=e}})